---
title: "The Clean and the Green"
subtitle: "Investigating the Relationship Between Income and Sanitation"
author: "Giovani Thai, William Gladden, Soren Paetau"
format: 
  html:
    self-contained: true
    code-tools: true
    code-fold: true
    toc: true
    number-sections: true
    smooth-scroll: true
    theme: minty
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
library(ggridges)
library(RColorBrewer)
```

# Project Proposal

## Data Description
```{r import}

sanitation.data <- read_csv("at_least_basic_sanitation_overall_access_percent.csv")
income.data <- read_csv("income_per_person_gdppercapita_ppp_inflation_adjusted.csv")
colnames(income.data) <- c("country", as.numeric(1799:2049))
```

### Income Dataset
```{r}
head(select(income.data, 1:5))
```
The income data set measures the total GDP of a country per person for 216 countries between the years of 1892 and 2049, with units in fixed 2017 prices. This number is adjusted for PPP, or the differences between costs of living and essential products, across countries. The data comes from the World Bank, the Maddison Project Database, and the Penn World Table. Historical estimates were used for early years; forecasts from the IMF's Economic Outlook were used to project income in the future.

Source: <https://www.gapminder.org/data/documentation/gd001/>

### Sanitation  Dataset
```{r}
head(select(sanitation.data, 1:5))
```
The sanitation data set measures the percentage of people (living in both urban and rural settings) who use at lease basic sanitation services not shared with other households. This includes:

+ flushing/pouring to piped sewer systems
+ septic
+ ventilation for pit latrines (e.g. squat toilets)

The data was collected by the World Health Organization and UNICEF, falling between the years of 1999 to 2019.

Source: <https://data.worldbank.org/indicator/SH.STA.SMSS.ZS>

## Hypothesized Relationship
We hypothesize that there will be a positive relation between income per person and percentage of people with basic sanitation at their disposal. We would also like to investigate and highlight any potential outliers, such as moments in time where certain countries failed to improve sanitation with increased income, or drastic dips/surges in income/sanitation over a single year.


## Data Cleaning Process
```{r cleaning}
convert_num <- function(x){ #converts "12.3k" to 12300,  
  temp <- x
  if(str_detect(x, "k$")){
    temp <- x |> 
      str_replace_all("[^[:digit:]]", "") |> #gross but it just replaces any non-number with ""
      as.numeric() * 100
  }
  return(temp)
}

#data cleaning + joining
sanitation.clean <- sanitation.data |>
  drop_na() |>
  pivot_longer(cols = `1999`:`2019`,
               names_to = "year",
               values_to = "sanitation")

income.clean <- income.data |>
  drop_na() |> #pretty bold step to remove any rows with na vals, 
               #but due to the abundance of data seems reasonable
  select(c(country, `1999`:`2019`)) |>
  pivot_longer(cols = `1999`:`2019`,
               names_to = "year",
               values_to = "income") |>
  mutate(income = as.numeric(map(income, convert_num)))#converts characters,
  #able to convert after pivot, b/c data is all seen as strings
```
The cleaning process above is relatively simple, converting some data entries of the form $12.3k \to 12300$. Notice that the decision to drop NA values was made, since `ggplot` and `lm` will drop NA values and we have an abundance of data entries. This decision will save headaches later down the road when taking advantage of the country column.

```{r join}
full.data <- inner_join(sanitation.clean, income.clean)
head(full.data)
```

# Linear Regression
We aim to piece together the relationship between income and sanitation levels.

## Data Visualization
Our goal is to develop a model that predicts the **percent of people with basic sanitation** (response) from **adjusted income per person** (explanatory).

### Macro-Scale Relation Between Income, Sanitation
We first visualize the relation between these two variables:

```{r relation}
full.data |>
  ggplot(mapping = aes(x = income, y = sanitation) ) +
  geom_point() +
  geom_smooth(method = lm, level = 0, color = "red") +
  scale_y_continuous(limits = c(0,100),
                     breaks = seq(0,100,25)) +
  labs(title = "Income versus Sanitation, 1999-2049",
       subtitle = "Percentage of People with (at least) Basic Sanitation Services",
       x = "Adjusted Income per Person (in 2017 $)",
       y = "")
```

Although the above scatter plot is very messy, we can see a general pattern: countries with low adjusted income per person have lower percentages of people with basic sanitation, whereas countries with high income per person never have less than 90 percent of people with basic sanitation.


However, there are instances where countries with very low income per person have high percentages of people with basic sanitation. Below you can see that the United States has had two years between 1999 and 2019 where adjusted income per person dipped below $20,000, but over 99% of Americans were able to have access to basic sanitation. 

```{r}
full.data |>
  filter(country == "United States") |>
  ggplot(mapping = aes(x = income, y = sanitation)) +
  geom_point() +
  labs(title = "United States Income vs. Sanitation, 1999-2019",
       subtitle = "Percentage of People with (at least) Basic Santitation",
       x = "Adjusted Income Per Person (in 2017 $)",
       y = "")
```
Despite an obvious general trend, further investigation is needed to gain insight on descrepancies like the ones above.

### Relationship over Time:
We look at the relationship between average income per person and average percentage of people with basic sanitation at their disposal across 1999-2019.
```{r relation-over-time}
# take average income and sanitation for each year, then plot?
# cleveland dot plots to better indicate year
# 1999 is lowest, 2019 is highest, everything else already in order.
full.data |>
  group_by(year) |>
  summarise(mean_income = mean(income),
            mean_sanitation = mean(sanitation)) |>
  ggplot(mapping = aes(x = mean_income,
                       y = mean_sanitation#,
                       #color = fct_reorder2(year, mean_income, mean_sanitation)
                       )
         ) +
  geom_segment(mapping = aes(xend = 0, yend = mean_sanitation)) +
  geom_point() +
  annotate("text", x = 17000, y = 76.6, label = "2019") +
  annotate("text", x = 14600, y = 65.8, label = "1999") +
  labs(title = "Average Income versus Average Sanitation, 1999-2019",
       subtitle = "Average Percentage of People with Basic Sanitation",
       x = "Average Income per Person (in 2017 $)",
       y = "",
       color = "Year")
```



## Linear regression
```{r}
#| include = F
data.fit <- lm(sanitation~income, data = full.data)
summary(data.fit)
```
Upon fitting a simple linear regression model for percent of people who have access to basic sanitation and adjusted income per person, we acquired the following regression equation:
$$\hat{\text{sanitation}} = 55.75 + 0.0009699\text{(income)}$$
Our regression equation tells us that if a country had an average adjusted income of $0, 55.75 percent of people would still have acess to basic sanitation services. Further, for every one dollar increase in adjusted income per person, a country should expect a 0.0009699 percent increase in the amount of people who have access to basic sanitation.

## Model Fit

variance in response -> 
variance in fitted from regression -> amount of variability in the response accounted for by the explanatory
variance in resid from regression -> amount of variability in responses that has not been account for

The proportion of variability that was accounted for by our model was 0.333. Our model does a good enough job to communicate the general idea that more money means people are going to be cleaner. However, the variable we are hoping predict is a percentage which means it can not exceed 100%, exposing the flaw that our model will predict impossible to reach sanitation percentages for high enough average income inputs. This causes us problems with what we can and can not conclude based on this model due to risk of extrapolating further than our data provides. There is not much we can do about this using a simple linear model as we would have to introduce a polynomial regression equation to be more precise. 
