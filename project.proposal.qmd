---
title: "The Clean and the Green"
subtitle: "Investigating the Relationship Between Income and Sanitation"
author: "Giovani Thai, William Gladden, Soren Paetau"
format: 
  html:
    self-contained: true
    code-tools: true
    code-fold: true
    toc: true
    number-sections: true
    smooth-scroll: true
    theme: minty
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
library(ggridges)
library(RColorBrewer)
library(knitr)
library(DT)
library(kableExtra)
library(gganimate)
library(gifski)
```

# Introduction
```{r import}

sanitation.data <- read_csv("at_least_basic_sanitation_overall_access_percent.csv")
income.data <- read_csv("income_per_person_gdppercapita_ppp_inflation_adjusted.csv")
colnames(income.data) <- c("country", as.numeric(1799:2049))
```

```{r}
head(select(income.data, 1:5))
```
The income data set measures the total GDP of a country per person for 216 countries between the years of 1892 and 2049, with units in fixed 2017 prices. This number is adjusted for PPP, or the differences between costs of living and essential products, across countries. The data comes from the World Bank, the Maddison Project Database, and the Penn World Table. Historical estimates were used for early years; forecasts from the IMF's Economic Outlook were used to project income in the future.

Source: <https://www.gapminder.org/data/documentation/gd001/>

### Sanitation  Dataset
```{r}
head(select(sanitation.data, 1:5))
```
The sanitation data set measures the percentage of people (living in both urban and rural settings) who use at lease basic sanitation services not shared with other households. This includes:

+ flushing/pouring to piped sewer systems
+ septic
+ ventilation for pit latrines (e.g. squat toilets)

The data was collected by the World Health Organization and UNICEF, falling between the years of 1999 to 2019.

Source: <https://data.worldbank.org/indicator/SH.STA.SMSS.ZS>

## Hypothesized Relationship
We hypothesize that there will be a positive relation between income per person and percentage of people with basic sanitation at their disposal. We would also like to investigate and highlight any potential outliers, such as moments in time where certain countries failed to improve sanitation with increased income, or drastic dips/surges in income/sanitation over a single year.


## Data Cleaning Process
```{r cleaning}
convert_num <- function(x){ #converts "12.3k" to 12300,  
  temp <- x
  if(str_detect(x, "k$")){
    temp <- x |> 
      str_replace_all("[^[:digit:]]", "") |> #gross but it just replaces any non-number with ""
      as.numeric() * 100
  }
  return(temp)
}

#data cleaning + joining
sanitation.clean <- sanitation.data |>
  drop_na() |>
  pivot_longer(cols = `1999`:`2019`,
               names_to = "year",
               values_to = "sanitation")

income.clean <- income.data |>
  drop_na() |> #pretty bold step to remove any rows with na vals, 
               #but due to the abundance of data seems reasonable
  select(c(country, `1999`:`2019`)) |>
  pivot_longer(cols = `1999`:`2019`,
               names_to = "year",
               values_to = "income") |>
  mutate(income = as.numeric(map(income, convert_num)))#converts characters,
  #able to convert after pivot, b/c data is all seen as strings!
```
The cleaning process above is relatively simple, converting some data entries of the form $12.3k \to 12300$. Notice that the decision to drop NA values was made, since `ggplot` and `lm` will drop NA values and we have an abundance of data entries. This decision will save headaches later down the road when taking advantage of the country column.

```{r join}
full.data <- inner_join(sanitation.clean, income.clean) |>
  mutate(year = as.numeric(year))

full.data |>
  slice_head(n = 1000) |>
  datatable(class = "cell-border",
            rownames = FALSE,
            caption = "Table 1: Preview of Data Set.",
            filter = "top")
```

# Linear Regression
We aim to piece together the relationship between income and sanitation levels.

## Data Visualization
Our goal is to develop a model that predicts the **percent of people with basic sanitation** (response) from **adjusted income per person** (explanatory).

### Macro-Scale Relation Between Income, Sanitation
We first visualize the relation between these two variables:

```{r relation}
data.plot <- full.data |>
  ggplot(mapping = aes(x = income, y = sanitation) ) +
  geom_point() +
  geom_smooth(method = lm, level = 0, color = "red") +
  scale_y_continuous(limits = c(0,100),
                     breaks = seq(0,100,25)) +
  labs(title = "Income versus Sanitation, 1999-2049",
       subtitle = "Percentage of People with (at least) Basic Sanitation Services",
       x = "Adjusted Income per Person (in 2017 $)",
       y = "") 

data.plot
```

Although the above scatter plot is very messy, we can see a general pattern: countries with low adjusted income per person have lower percentages of people with basic sanitation, whereas countries with high income per person never have less than 90 percent of people with basic sanitation.

However, there are instances where countries with very low income per person have high percentages of people with basic sanitation. Below you can see that the United States has had two years between 1999 and 2019 where adjusted income per person dipped below $20,000, but over 99% of Americans were able to have access to basic sanitation. 

```{r}
p <- full.data |>
    mutate(year = as.numeric(year)) |>
    filter(country == "United States") |>
    ggplot(mapping = aes(x = income, y = sanitation)) +
    geom_point() +
    transition_time(year) +
    labs(title = "United States Income vs. Sanitation, 1999-2019",
        subtitle = "Year: {floor(frame_time)}",
        x = "Adjusted Income Per Person (in 2017 $)",
        y = "Percentage of People with (at least) Basic Santitation") +
    shadow_mark(alpha = 1, 
                size = 1)
animate(p, duration = 5, fps = 20, renderer = gifski_renderer(), end_pause = 40)
anim_save("animated_US_plot.gif", animation = last_animation())
```

Despite an obvious general trend, further investigation is needed to gain insight on descrepancies like the ones above.

### Relationship over Time:
We look at the relationship between average income per person and average percentage of people with basic sanitation at their disposal across 1999-2019.

```{r}
temp.plot <- full.data |>
  mutate(year = as.numeric(year)) |>
  ggplot(mapping = aes(x = income,
                       y = sanitation)) +
  geom_point(show.legend = F) +
  transition_time(year) +
  labs(title = "Income versus Sanitation, 1999-2019",
       subtitle = "Year: {floor(frame_time)}",
       x = "Adjusted Income per Person (in 2017 $)",
       y = "Percentage of People with (at least) Basic Sanitation Services") +
  shadow_mark(keep_layer = T, size = 0.1, alpha = 0.5) +
  enter_fade() +
  exit_fade()

animate(temp.plot, duration = 10, fps = 10, renderer = gifski_renderer())
anim_save("animated_time_plot.gif", animation = last_animation())
```

The proportion of variability accounted for by our model was 0.333. Our model does a good enough job to communicate the general idea that more money means people are going to be cleaner. However, the variable we are hoping to predict is a percentage which means it can not exceed 100%, exposing the flaw that our model will predict impossible to reach sanitation percentages for high enough average income inputs. This gives us problems regarding what we can and can not conclude due to risk of extrapolating further than our data provides. There is not much we can do about this using a simple linear model as we would have to introduce a polynomial regression equation (say, through a logarithmic transformation) to be more precise.

# Simulation
```{r}
sanitation_lm <- lm(sanitation ~ income, data = full.data)
sanitation_predict <- predict(sanitation_lm)
head(sanitation_predict)

```
Pull Sigma = residual standard error
```{r}
san_sigma <- sigma(sanitation_lm)
san_sigma
```
Noise Function:
```{r}
noise <- function(x, mean = 0, sd){
  x + rnorm(length(x), 
            mean, 
            sd)
}
```
Simulated Response:
```{r}
sim_response <- tibble(sim_sanitation = noise(sanitation_predict, 
                                           sd = san_sigma)
                   )
head(sim_response)
```

